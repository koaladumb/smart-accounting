<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Accounting V14.20 - Triple Checked</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="bg-slate-100 p-4 md:p-8" x-data="accountingSystem()" x-init="init()">

    <div class="max-w-7xl mx-auto">
        <header class="mb-6 flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
            <div>
                <h1 class="text-3xl font-black text-slate-800 tracking-tight italic uppercase">Smart<span class="text-indigo-600 font-normal">Accounting</span></h1>
                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-[0.2em]">V14.20 - Verified Logic & Stability</p>
            </div>
            <div class="flex flex-wrap gap-2 mt-4 md:mt-0">
                <button @click="downloadBackup" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-[10px] font-bold hover:bg-indigo-700 shadow-md transition-all">üíæ BACKUP</button>
                <label class="bg-amber-500 text-white px-4 py-2 rounded-xl text-[10px] font-bold hover:bg-amber-600 cursor-pointer shadow-md transition-all">
                    üìÇ RESTORE <input type="file" @change="importBackup" class="hidden">
                </label>
                <button @click="resetData" class="bg-rose-50 text-rose-500 px-4 py-2 rounded-xl text-[10px] font-bold hover:bg-rose-100">üóëÔ∏è RESET</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-4">
                <div class="bg-white p-8 rounded-3xl shadow-xl border border-slate-200 sticky top-4">
                    <h2 class="font-black text-slate-800 mb-6 uppercase italic text-xl border-b pb-4">Input Transaksi</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="text-[9px] font-bold text-slate-400 uppercase">Tanggal</label>
                            <input type="date" x-model="form.date" class="w-full border-2 border-slate-50 p-3 rounded-xl font-bold text-slate-600 outline-none bg-slate-50">
                        </div>
                        <div>
                            <label class="text-[9px] font-bold text-slate-400 uppercase">Jenis Transaksi</label>
                            <select x-model="form.categoryKey" @change="handleCategoryChange" class="w-full border-2 border-indigo-50 p-3 rounded-xl text-[11px] font-bold bg-indigo-50 text-indigo-700 outline-none">
                                <option value="">-- PILIH KATEGORI --</option>
                                <template x-for="(cat, key) in smartCategories" :key="key">
                                    <option :value="key" x-text="cat.label"></option>
                                </template>
                            </select>
                        </div>

                        <div x-show="needsAccountSelect()" class="p-4 bg-indigo-50/50 rounded-2xl border border-indigo-100 space-y-3 shadow-inner">
                            <div>
                                <label class="text-[9px] font-bold text-indigo-500 uppercase" x-text="accountLabel()"></label>
                                <select x-model="form.source" class="w-full border-2 border-white p-2.5 rounded-lg text-xs font-bold shadow-sm outline-none">
                                    <template x-for="acc in coa.filter(a => a.type === 'Asset' && a.code !== '1-1300')">
                                        <option :value="acc.code" x-text="acc.name"></option>
                                    </template>
                                </select>
                            </div>
                            <div x-show="form.categoryKey === 'transfer'">
                                <label class="text-[9px] font-bold text-rose-500 uppercase mt-2 block italic text-center">Ke Akun Tujuan</label>
                                <select x-model="form.target" class="w-full border-2 border-white p-2.5 rounded-lg text-xs font-bold shadow-sm outline-none">
                                    <template x-for="acc in coa.filter(a => a.type === 'Asset' && a.code !== '1-1300')">
                                        <option :value="acc.code" x-text="acc.name"></option>
                                    </template>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="text-[9px] font-bold text-slate-400 uppercase">Nominal</label>
                            <input type="text" :value="formattedAmount" @input="updateAmount($event.target.value)" placeholder="Rp 0" class="w-full border-2 border-slate-50 p-4 rounded-xl font-black text-xl text-indigo-600 outline-none bg-slate-50">
                        </div>
                        <div>
                            <label class="text-[9px] font-bold text-slate-400 uppercase">Keterangan</label>
                            <input type="text" x-model="form.desc" placeholder="Catatan..." class="w-full border-2 border-slate-50 p-3 rounded-xl text-xs outline-none bg-slate-50 italic">
                        </div>
                        <button @click="hardPost" class="w-full bg-slate-800 text-white py-4 rounded-2xl font-black uppercase tracking-widest hover:bg-indigo-600 shadow-lg active:scale-95 transition-all">POSTING</button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-8 space-y-6">
                <div class="bg-white p-4 rounded-3xl shadow-sm border border-slate-200">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <input type="text" x-model="filters.search" placeholder="Cari log..." class="border-2 border-slate-50 bg-slate-50 p-2.5 rounded-xl text-[10px] font-bold outline-none focus:border-indigo-300">
                        <div class="flex items-center gap-2 md:col-span-2">
                            <input type="date" x-model="filters.start" class="w-full border-2 border-slate-50 bg-slate-50 p-2.5 rounded-xl text-[10px] font-bold">
                            <span class="text-[9px] font-bold text-slate-400 uppercase font-black">S/D</span>
                            <input type="date" x-model="filters.end" class="w-full border-2 border-slate-50 bg-slate-50 p-2.5 rounded-xl text-[10px] font-bold">
                        </div>
                    </div>
                </div>

                <nav class="flex flex-wrap gap-2 bg-white p-2 rounded-2xl shadow-sm border border-slate-200 overflow-x-auto">
                    <template x-for="tab in ['Utama', 'Neraca', 'Arus Kas', 'Buku Besar', 'Umur Piutang']">
                        <button @click="activeTab = tab" :class="activeTab === tab ? 'bg-indigo-600 text-white shadow-md' : 'text-slate-500 hover:bg-slate-100'" class="px-5 py-2.5 rounded-xl text-[10px] font-black uppercase transition-all whitespace-nowrap" x-text="tab"></button>
                    </template>
                </nav>

                <main class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 min-h-[400px]">
                    <div x-show="activeTab === 'Utama'" class="space-y-6">
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div class="bg-emerald-500 p-5 rounded-3xl text-white shadow-md font-black">
                                <p class="text-[9px] uppercase opacity-80 italic">Pendapatan</p>
                                <h3 class="text-xl" x-text="formatIDR(filteredTotals.revenue)"></h3>
                            </div>
                            <div class="bg-indigo-600 p-5 rounded-3xl text-white shadow-md font-black">
                                <p class="text-[9px] uppercase opacity-80 italic">Laba Bersih</p>
                                <h3 class="text-xl" x-text="formatIDR(filteredTotals.revenue - filteredTotals.expense)"></h3>
                            </div>
                            <div class="bg-slate-800 p-5 rounded-3xl text-white shadow-md font-black col-span-2 md:col-span-1">
                                <p class="text-[9px] uppercase opacity-80 italic">Margin Laba</p>
                                <h3 class="text-xl" x-text="profitMargin + '%'"></h3>
                            </div>
                        </div>
                        <h2 class="font-black text-slate-800 mb-4 uppercase text-xs border-l-4 border-slate-800 pl-3">Ringkasan Saldo Akun</h2>
                        <table class="w-full text-sm">
                            <template x-for="row in trialBalance" :key="row.code">
                                <tr class="border-b border-slate-50 hover:bg-slate-50 transition-colors">
                                    <td class="py-3 font-bold text-slate-600" x-text="row.name"></td>
                                    <td class="py-3 text-right font-black" :class="(row.type==='Asset'||row.type==='Expense') ? 'text-indigo-600' : 'text-rose-500'" x-text="formatIDR(row.debit > 0 ? row.debit : row.kredit)"></td>
                                </tr>
                            </template>
                        </table>
                    </div>

                    <div x-show="activeTab === 'Neraca'" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="p-6 bg-slate-50 rounded-3xl border border-slate-200">
                            <h3 class="font-black text-indigo-600 mb-4 uppercase text-[10px]">Aktiva</h3>
                            <template x-for="row in trialBalance.filter(r => r.type === 'Asset')" :key="row.code">
                                <div class="flex justify-between border-b border-white py-2 text-sm"><span x-text="row.name"></span><span class="font-bold" x-text="formatIDR(row.debit)"></span></div>
                            </template>
                            <div class="flex justify-between pt-4 font-black text-indigo-600 border-t border-indigo-100"><span>TOTAL ASET</span><span x-text="formatIDR(totalAssets)"></span></div>
                        </div>
                        <div class="p-6 bg-slate-50 rounded-3xl border border-slate-200">
                            <h3 class="font-black text-rose-500 mb-4 uppercase text-[10px]">Pasiva</h3>
                            <template x-for="row in trialBalance.filter(r => r.type === 'Liability')" :key="row.code">
                                <div class="flex justify-between border-b border-white py-2 text-sm"><span x-text="row.name"></span><span class="font-bold" x-text="formatIDR(row.kredit)"></span></div>
                            </template>
                            <div class="flex justify-between py-2 text-sm"><span>Modal Pemilik</span><span class="font-bold" x-text="formatIDR(equityReport.invest)"></span></div>
                            <div class="flex justify-between py-2 text-sm text-emerald-600 italic"><span>Laba Berjalan</span><span class="font-bold" x-text="formatIDR(totalRevenue - totalExpense)"></span></div>
                            <div class="flex justify-between pt-4 font-black text-rose-500 border-t border-rose-100"><span>TOTAL PASIVA</span><span x-text="formatIDR(totalPasiva)"></span></div>
                        </div>
                    </div>

                    <div x-show="activeTab === 'Arus Kas'" class="space-y-4">
                        <div class="flex justify-between p-4 bg-emerald-50 rounded-2xl text-xs"><span>Uang Masuk Tunai</span><span class="font-black text-emerald-600" x-text="formatIDR(cashFlow.in)"></span></div>
                        <div class="flex justify-between p-4 bg-rose-50 rounded-2xl text-xs"><span>Uang Keluar Tunai</span><span class="font-black text-rose-600" x-text="formatIDR(cashFlow.out)"></span></div>
                        <div class="flex justify-between p-6 bg-slate-800 text-white rounded-3xl font-black shadow-lg"><span>SALDO KAS NETTO</span><span x-text="formatIDR(cashFlow.net)"></span></div>
                    </div>

                    <div x-show="activeTab === 'Buku Besar'" class="space-y-4">
                        <select x-model="selectedGlAccount" class="w-full border-2 border-slate-100 p-2 rounded-xl text-[10px] font-bold outline-none">
                            <template x-for="acc in coa" :key="acc.code"><option :value="acc.code" x-text="acc.name"></option></template>
                        </select>
                        <div class="overflow-x-auto rounded-xl border border-slate-100">
                            <table class="w-full text-[10px]">
                                <thead class="bg-slate-50 text-slate-400 uppercase font-black"><tr><th class="p-3 text-left">Tgl</th><th class="p-3 text-left">Keterangan</th><th class="p-3 text-right">Debit</th><th class="p-3 text-right">Kredit</th></tr></thead>
                                <template x-for="gl in generalLedger" :key="gl.id">
                                    <tr class="border-b"><td class="p-3" x-text="gl.date"></td><td class="p-3 font-bold uppercase" x-text="gl.label"></td><td class="p-3 text-right text-emerald-600 font-bold" x-text="gl.dr > 0 ? formatIDR(gl.dr) : '-'"></td><td class="p-3 text-right text-rose-500 font-bold" x-text="gl.cr > 0 ? formatIDR(gl.cr) : '-'"></td></tr>
                                </template>
                            </table>
                        </div>
                    </div>

                    <div x-show="activeTab === 'Umur Piutang'" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="p-6 bg-slate-50 rounded-2xl text-center border border-slate-200">
                            <p class="text-[10px] font-black uppercase text-slate-400">0-30 Hari</p>
                            <p class="text-xl font-black text-slate-800" x-text="formatIDR(aging.current)"></p>
                        </div>
                        <div class="p-6 bg-amber-50 rounded-2xl text-center border border-amber-200">
                            <p class="text-[10px] font-black uppercase text-amber-500">31-60 Hari</p>
                            <p class="text-xl font-black text-amber-600" x-text="formatIDR(aging.warn)"></p>
                        </div>
                        <div class="p-6 bg-rose-50 rounded-2xl text-center border border-rose-200">
                            <p class="text-[10px] font-black uppercase text-rose-500">>60 Hari</p>
                            <p class="text-xl font-black text-rose-600" x-text="formatIDR(aging.danger)"></p>
                        </div>
                    </div>
                </main>

                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 mt-6">
                    <h2 class="font-black text-slate-800 mb-4 uppercase text-[10px] border-l-4 border-slate-800 pl-3">Riwayat Jurnal Terfilter</h2>
                    <div class="space-y-2 max-h-96 overflow-y-auto pr-2">
                        <template x-for="j in filteredJournal" :key="j.id">
                            <div class="p-4 bg-slate-50 rounded-2xl flex justify-between items-center text-xs hover:bg-white border border-transparent hover:border-slate-100 transition-all">
                                <div><div class="flex items-center gap-2"><span class="text-[8px] font-black bg-indigo-100 text-indigo-600 px-1.5 rounded" x-text="j.date"></span><p class="font-black text-slate-700 uppercase" x-text="j.smartLabel"></p></div><p class="text-[10px] text-slate-400 italic mt-1" x-text="j.desc || '-'"></p></div>
                                <div class="flex items-center gap-4"><p class="font-black text-indigo-600 text-sm" x-text="formatIDR(j.amount)"></p><button @click="deleteEntry(j.id)" class="text-slate-200 hover:text-rose-500 transition-colors">üóëÔ∏è</button></div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function accountingSystem() {
            return {
                coa: [
                    { code: "1-1100", name: "Kas Utama", type: "Asset" },
                    { code: "1-1200", name: "Bank", type: "Asset" },
                    { code: "1-1300", name: "Piutang Usaha", type: "Asset" },
                    { code: "2-1100", name: "Utang Usaha", type: "Liability" },
                    { code: "3-1100", name: "Modal Pemilik", type: "Equity" },
                    { code: "4-1100", name: "Pendapatan Jasa", type: "Revenue" },
                    { code: "5-1100", name: "Beban Operasional", type: "Expense" }
                ],
                smartCategories: {
                    income: { label: "PENDAPATAN TUNAI", dr: "fundSource", cr: "4-1100", hasAccount: true },
                    expense: { label: "BIAYA OPERASIONAL", dr: "5-1100", cr: "fundSource", hasAccount: true },
                    receivable_in: { label: "PENAMBAHAN PIUTANG", dr: "1-1300", cr: "4-1100", hasAccount: false },
                    receivable_pay: { label: "PELUNASAN PIUTANG", dr: "fundSource", cr: "1-1300", hasAccount: true },
                    payable_service: { label: "PENAMBAHAN UTANG", dr: "5-1100", cr: "2-1100", hasAccount: false },
                    loan_in: { label: "TERIMA PINJAMAN", dr: "fundSource", cr: "2-1100", hasAccount: true },
                    payable_pay: { label: "PEMBAYARAN UTANG", dr: "2-1100", cr: "fundSource", hasAccount: true },
                    transfer: { label: "TRANSFER ANTAR AKUN", dr: "transferTo", cr: "fundSource", hasAccount: true },
                    equity_in: { label: "SETORAN MODAL", dr: "fundSource", cr: "3-1100", hasAccount: true },
                    equity_out: { label: "PENARIKAN MODAL (PRIVE)", dr: "3-1100", cr: "fundSource", hasAccount: true }
                },
                form: { date: new Date().toISOString().split('T')[0], categoryKey: '', amount: 0, desc: '', source: '1-1100', target: '1-1200' },
                filters: { search: '', start: '', end: '' },
                activeTab: 'Utama', selectedGlAccount: '1-1100',
                journal: JSON.parse(localStorage.getItem('smart_acc_v20_verified') || '[]'),
                trialBalance: [], totalRevenue: 0, totalExpense: 0, totalAssets: 0, totalPasiva: 0,

                init() { this.calculateLaporan(); },

                handleCategoryChange() {
                    if (!this.smartCategories[this.form.categoryKey]?.hasAccount) {
                        this.form.source = '1-1100'; // Hard Reset to default if not needed
                    }
                    if (this.form.categoryKey === 'transfer') { this.form.source = '1-1100'; this.form.target = '1-1200'; }
                },

                get filteredJournal() {
                    return this.journal.filter(j => {
                        const searchLower = this.filters.search.toLowerCase();
                        const matchSearch = (j.desc || '').toLowerCase().includes(searchLower) || j.smartLabel.toLowerCase().includes(searchLower);
                        const matchStart = this.filters.start ? j.date >= this.filters.start : true;
                        const matchEnd = this.filters.end ? j.date <= this.filters.end : true;
                        return matchSearch && matchStart && matchEnd;
                    });
                },

                get filteredTotals() {
                    let rev = 0, exp = 0;
                    this.filteredJournal.forEach(j => {
                        if (["PENDAPATAN TUNAI", "PENAMBAHAN PIUTANG"].includes(j.smartLabel)) rev += j.amount;
                        if (["BIAYA OPERASIONAL", "PENAMBAHAN UTANG"].includes(j.smartLabel)) exp += j.amount;
                    });
                    return { revenue: rev, expense: exp };
                },

                get profitMargin() {
                    if (this.filteredTotals.revenue === 0) return 0;
                    const profit = this.filteredTotals.revenue - this.filteredTotals.expense;
                    return ((profit / this.filteredTotals.revenue) * 100).toFixed(1);
                },

                needsAccountSelect() { return this.form.categoryKey && this.smartCategories[this.form.categoryKey].hasAccount; },
                accountLabel() { return this.form.categoryKey === 'transfer' ? "DARI AKUN" : "AKUN KAS/BANK"; },
                get formattedAmount() { return this.form.amount ? new Intl.NumberFormat('id-ID').format(this.form.amount) : ""; },
                updateAmount(val) { const clean = val.replace(/\D/g, ''); this.form.amount = clean ? parseInt(clean) : 0; },
                formatIDR(val) { return 'Rp ' + (val || 0).toLocaleString('id-ID'); },

                hardPost() {
                    if (!this.form.categoryKey || this.form.amount <= 0) return alert("Lengkapi data transaksi!");
                    const cat = this.smartCategories[this.form.categoryKey];
                    let dAcc = (cat.dr === "fundSource") ? this.form.source : (cat.dr === "transferTo" ? this.form.target : cat.dr);
                    let kAcc = (cat.cr === "fundSource") ? this.form.source : (cat.cr === "transferTo" ? this.form.target : cat.cr);
                    
                    if (this.form.categoryKey === 'transfer' && dAcc === kAcc) return alert("Akun tidak boleh sama!");
                    
                    // Cash Check Warning
                    const currentBalance = this.trialBalance.find(b => b.code === this.form.source)?.debit || 0;
                    if (cat.cr === 'fundSource' && currentBalance < this.form.amount) {
                        if(!confirm("Saldo kas tidak mencukupi. Lanjutkan transaksi?")) return;
                    }

                    this.journal.unshift({ id: Date.now(), date: this.form.date, smartLabel: cat.label, amount: this.form.amount, desc: this.form.desc, debitAcc: dAcc, kreditAcc: kAcc, category: this.form.categoryKey });
                    this.save(); this.form.amount = 0; this.form.desc = ''; this.form.date = new Date().toISOString().split('T')[0]; this.calculateLaporan();
                },

                calculateLaporan() {
                    let summary = {}; this.totalRevenue = 0; this.totalExpense = 0; this.totalAssets = 0;
                    this.coa.forEach(a => summary[a.code] = { ...a, rawD: 0, rawK: 0 });
                    this.journal.forEach(j => { 
                        if(summary[j.debitAcc]) summary[j.debitAcc].rawD += j.amount; 
                        if(summary[j.kreditAcc]) summary[j.kreditAcc].rawK += j.amount; 
                    });
                    this.trialBalance = Object.values(summary).map(item => {
                        let d = 0, k = 0, s = item.rawD - item.rawK;
                        if (item.type === 'Asset' || item.type === 'Expense') { s >= 0 ? d = s : k = Math.abs(s); } 
                        else { s = item.rawK - item.rawD; s >= 0 ? k = s : d = Math.abs(s); }
                        if(item.type === 'Revenue') this.totalRevenue += (k - d);
                        if(item.type === 'Expense') this.totalExpense += (d - k);
                        if(item.type === 'Asset') this.totalAssets += (d - k);
                        return { ...item, debit: d, kredit: k };
                    }).filter(i => i.debit !== 0 || i.kredit !== 0);
                    let utang = 0; this.trialBalance.filter(r => r.type === 'Liability').forEach(u => utang += u.kredit);
                    this.totalPasiva = utang + this.equityReport.invest + (this.totalRevenue - this.totalExpense);
                },

                get cashFlow() {
                    let cin = 0, cout = 0;
                    this.journal.forEach(j => {
                        const isCash = (acc) => acc === '1-1100' || acc === '1-1200';
                        if (j.category === 'transfer') return;
                        if(isCash(j.debitAcc) && !isCash(j.kreditAcc)) cin += j.amount;
                        if(!isCash(j.debitAcc) && isCash(j.kreditAcc)) cout += j.amount;
                    });
                    return { in: cin, out: cout, net: cin - cout };
                },

                get generalLedger() {
                    return this.journal.filter(j => j.debitAcc === this.selectedGlAccount || j.kreditAcc === this.selectedGlAccount)
                        .map(j => ({ id: j.id, date: j.date, label: j.smartLabel, dr: j.debitAcc === this.selectedGlAccount ? j.amount : 0, cr: j.kreditAcc === this.selectedGlAccount ? j.amount : 0 }));
                },

                get aging() {
                    let cur = 0, warn = 0, danger = 0; const today = new Date();
                    this.journal.forEach(j => {
                        if(j.debitAcc === '1-1300' || j.kreditAcc === '1-1300') {
                            const diff = Math.floor((today - new Date(j.date)) / 86400000);
                            const val = j.debitAcc === '1-1300' ? j.amount : -j.amount;
                            if(diff <= 30) cur += val; else if(diff <= 60) warn += val; else danger += val;
                        }
                    });
                    return { current: Math.max(0, cur), warn: Math.max(0, warn), danger: Math.max(0, danger) };
                },

                get equityReport() {
                    let inv = 0;
                    this.journal.forEach(j => { if(j.kreditAcc === '3-1100') inv += j.amount; if(j.debitAcc === '3-1100') inv -= j.amount; });
                    return { invest: inv };
                },

                save() { localStorage.setItem('smart_acc_v20_verified', JSON.stringify(this.journal)); },
                deleteEntry(id) { if(confirm("Hapus data ini?")) { this.journal = this.journal.filter(j => j.id !== id); this.save(); this.calculateLaporan(); } },
                resetData() { if(confirm("Hapus seluruh database permanen?")) { localStorage.removeItem('smart_acc_v20_verified'); location.reload(); } },
                downloadBackup() { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.journal)); const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", "BACKUP_VERIFIED_V20.json"); dl.click(); },
                importBackup(e) { const reader = new FileReader(); reader.onload = (ev) => { this.journal = JSON.parse(ev.target.result); this.save(); location.reload(); }; reader.readAsText(e.target.files[0]); }
            }
        }
    </script>
</body>
</html>
